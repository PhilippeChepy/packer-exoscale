patches:
- target:
    kind: CustomResourceDefinition
  patch: |-
    - op: remove
      path: /metadata/creationTimestamp

- target:
    kind: Deployment
    name: external-secrets
  patch: |-
    - op: add
      path: /spec/template/spec/affinity
      value:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - topologyKey: kubernetes.io/hostname
            labelSelector:
              matchLabels:
                app.kubernetes.io/instance: external-secrets
                app.kubernetes.io/name: external-secrets

- target:
    kind: Deployment
    name: external-secrets-cert-controller
  patch: |-
    - op: add
      path: /spec/template/spec/affinity
      value:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - topologyKey: kubernetes.io/hostname
            labelSelector:
              matchLabels:
                app.kubernetes.io/instance: external-secrets
                app.kubernetes.io/name: external-secrets-cert-controller
    - op: add
      path: /spec/template/spec/containers/0/livenessProbe
      value:
        httpGet:
          path: /readyz
          port: 8081
          scheme: HTTP
        initialDelaySeconds: 5
        periodSeconds: 5
        successThreshold: 1
        failureThreshold: 3
        timeoutSeconds: 2

- target:
    kind: Deployment
    name: external-secrets-webhook
  patch: |-
    - op: remove
      path: /spec/template/spec/hostNetwork
    - op: add
      path: /spec/template/spec/affinity
      value:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - topologyKey: kubernetes.io/hostname
            labelSelector:
              matchLabels:
                app.kubernetes.io/instance: external-secrets
                app.kubernetes.io/name: external-secrets-webhook
    - op: add
      path: /spec/template/spec/containers/0/livenessProbe
      value:
        httpGet:
          path: /readyz
          port: 8081
          scheme: HTTP
        initialDelaySeconds: 5
        periodSeconds: 5
        successThreshold: 1
        failureThreshold: 3
        timeoutSeconds: 2

- target:
    kind: Deployment
  patch: |-
    - op: add
      path: /spec/replicas
      value: 2
    - op: add
      path: /spec/template/spec/containers/0/resources
      value:
        limits:
          cpu: 100m
          memory: 64Mi
        requests:
          cpu: 100m
          memory: 32Mi
    - op: add
      path: /spec/template/spec/containers/0/securityContext
      value:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 1000
        capabilities:
          drop:
          - ALL

helmGlobals:
  chartHome: .helm
  configHome: .helm

helmCharts:
- name: external-secrets
  repo: https://charts.external-secrets.io
  releaseName: external-secrets
  namespace: external-secrets
  valuesInline:
    installCRDs: true

namespace: external-secrets
