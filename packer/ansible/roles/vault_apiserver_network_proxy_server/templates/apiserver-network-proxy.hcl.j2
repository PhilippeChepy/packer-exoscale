vault {
  address = "VAULT_ADDRESS"
  ca_cert = "{{ vault_tls_config_path }}/ca.pem"
}

exit_after_auth = true

auto_auth {
  method "approle" {
    mount_path = "{{ vault_agent_kube_control_plane_auth_path }}"

    config = {
      role_id_file_path                   = "{{ vault_agent_approle_path }}/.role_id"
      secret_id_file_path                 = "{{ vault_agent_approle_path }}/.instance_id"
      remove_secret_id_file_after_reading = false
    }
  }
}

template {
  contents    = <<EOT
apiVersion: v1
clusters:
- cluster:
<<- with secret "{{ vault_agent_secrets['pki_controlplane_ca_chain'] }}" >>
    certificate-authority-data: << base64Encode .Data.ca_chain >>
<<- end >>
    server: https://CLUSTER_MEMBER_ADDRESS:6443
  name: local
contexts:
- context:
    cluster: local
    user: system:konnectivity-server
  name: default
current-context: default
kind: Config
preferences: {}
users:
- name: system:konnectivity-server
  user:
<<- with secret "{{ vault_agent_secrets['pki_controlplane_cert_konnectivity'] }}" "common_name=system:konnectivity-server" "ttl=24h" >>
    client-certificate-data: << base64Encode .Data.certificate >>
    client-key-data: << base64Encode .Data.private_key >>
<<- end >>
EOT

  error_on_missing_key = true
  left_delimiter       = "<<"
  right_delimiter      = ">>"
  destination          = "{{ apiserver_network_proxy_server_config_path }}/apiserver-network-proxy.kubeconfig"
  perms                = 0600
  user                 = "{{ apiserver_network_proxy_server_user }}"
  group                = "{{ apiserver_network_proxy_server_group }}"
}

template {
  contents    = <<EOT
<<- with secret "{{ vault_agent_secrets['pki_konnectivity_cert_cluster'] }}" "common_name=konnectivity" "alt_names=konnectivity" "ip_sans=CLUSTER_NLB_ADDRESS,CLUSTER_MEMBER_ADDRESS,127.0.0.1" "ttl=24h" ->>
<< .Data.private_key >>
<<- end ->>
EOT

  error_on_missing_key = true
  left_delimiter       = "<<"
  right_delimiter      = ">>"
  destination          = "{{ apiserver_network_proxy_server_config_path }}/cluster.key"
  perms                = 0400
  user                 = "{{ apiserver_network_proxy_server_user }}"
  group                = "{{ apiserver_network_proxy_server_group }}"
}

template {
  contents    = <<EOT
<<- with secret "{{ vault_agent_secrets['pki_konnectivity_cert_cluster'] }}" "common_name=konnectivity" "alt_names=konnectivity" "ip_sans=CLUSTER_NLB_ADDRESS,CLUSTER_MEMBER_ADDRESS,127.0.0.1" "ttl=24h" ->>
<< .Data.certificate >>
<<- end ->>
EOT

  error_on_missing_key = true
  left_delimiter       = "<<"
  right_delimiter      = ">>"
  destination          = "{{ apiserver_network_proxy_server_config_path }}/cluster.pem"
  perms                = 0644
  user                 = "{{ apiserver_network_proxy_server_user }}"
  group                = "{{ apiserver_network_proxy_server_group }}"
}
